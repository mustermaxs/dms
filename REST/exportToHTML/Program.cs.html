<html>
<head>
<title>Program.cs</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6c95eb;}
.s1 { color: #d0d0d0;}
.s2 { color: #bdbdbd;}
.s3 { color: #85c46c; font-style: italic;}
.s4 { color: #c9a26d;}
</style>
</head>
<body bgcolor="#262626">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Program.cs</font>
</center></td></tr></table>
<pre><span class="s0">using </span><span class="s1">System</span><span class="s2">.</span><span class="s1">Reflection</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">DMS</span><span class="s2">.</span><span class="s1">Application</span><span class="s2">.</span><span class="s1">Commands</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">DMS</span><span class="s2">.</span><span class="s1">Domain</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">DMS</span><span class="s2">.</span><span class="s1">Domain</span><span class="s2">.</span><span class="s1">Entities</span><span class="s2">.</span><span class="s1">DomainEvents</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">DMS</span><span class="s2">.</span><span class="s1">Domain</span><span class="s2">.</span><span class="s1">IRepositories</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">DMS</span><span class="s2">.</span><span class="s1">Infrastructure</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">DMS</span><span class="s2">.</span><span class="s1">Infrastructure</span><span class="s2">.</span><span class="s1">EventHandlers</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">DMS</span><span class="s2">.</span><span class="s1">Infrastructure</span><span class="s2">.</span><span class="s1">Repositories</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">DMS</span><span class="s2">.</span><span class="s1">Infrastructure</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">log4net</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">log4net</span><span class="s2">.</span><span class="s1">Config</span><span class="s2">;</span>
<span class="s0">using </span><span class="s1">Microsoft</span><span class="s2">.</span><span class="s1">EntityFrameworkCore</span><span class="s2">;</span>
<span class="s3">// using DMS.Domain.Repositories;</span>
<span class="s3">// using DMS.Infrastructure.Repositories;</span>
<span class="s3">// using DMS.Infrastructure.Persistence;</span>
<span class="s0">using </span><span class="s1">MediatR</span><span class="s2">;</span>

<span class="s1">var builder </span><span class="s2">= </span><span class="s1">WebApplication</span><span class="s2">.</span><span class="s1">CreateBuilder</span><span class="s2">(</span><span class="s1">args</span><span class="s2">);</span>

<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddMediatR</span><span class="s2">(</span>
    <span class="s0">typeof</span><span class="s2">(</span><span class="s1">UploadDocumentCommand</span><span class="s2">).</span><span class="s1">Assembly</span>
    <span class="s2">);</span>

<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddControllers</span><span class="s2">();</span>
<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddEndpointsApiExplorer</span><span class="s2">();</span>
<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddSwaggerGen</span><span class="s2">();</span>

<span class="s3">// use log4net for logging</span>
<span class="s1">var logRepository </span><span class="s2">= </span><span class="s1">LogManager</span><span class="s2">.</span><span class="s1">GetRepository</span><span class="s2">(</span><span class="s1">Assembly</span><span class="s2">.</span><span class="s1">GetEntryAssembly</span><span class="s2">());</span>
<span class="s1">XmlConfigurator</span><span class="s2">.</span><span class="s1">Configure</span><span class="s2">(</span><span class="s1">logRepository</span><span class="s2">, </span><span class="s0">new </span><span class="s1">FileInfo</span><span class="s2">(</span><span class="s4">&quot;log4net.config&quot;</span><span class="s2">));</span>

<span class="s3">// Clear default logging providers and add log4net</span>
<span class="s1">builder</span><span class="s2">.</span><span class="s1">Logging</span><span class="s2">.</span><span class="s1">ClearProviders</span><span class="s2">();  </span><span class="s3">// Remove other logging providers (optional)</span>
<span class="s1">builder</span><span class="s2">.</span><span class="s1">Logging</span><span class="s2">.</span><span class="s1">AddLog4Net</span><span class="s2">();  </span>
<span class="s3">// Add PostgreSQL support with Entity Framework Core</span>
<span class="s3">//var connectionString = builder.Configuration.GetConnectionString(&quot;DefaultConnection&quot;);</span>
<span class="s3">//builder.Services.AddDbContext&lt;DMSDbContext&gt;(options =&gt;</span>
<span class="s3">//options.UseNpgsql(connectionString));</span>

<span class="s3">// Register repositories and services</span>
<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddScoped</span><span class="s2">&lt;</span><span class="s1">IDomainEventDispatcher</span><span class="s2">, </span><span class="s1">DomainEventDispatcher</span><span class="s2">&gt;();</span>
<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddScoped</span><span class="s2">&lt;</span><span class="s1">IDomainEventHandler</span><span class="s2">&lt;</span><span class="s1">DocumentUploadedEvent</span><span class="s2">&gt;, </span><span class="s1">DocumentCreatedEventHandler</span><span class="s2">&gt;();</span>
<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddScoped</span><span class="s2">&lt;</span><span class="s1">IMessageBrokerClient</span><span class="s2">, </span><span class="s1">RabbitMqClient</span><span class="s2">&gt;();</span>
<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddScoped</span><span class="s2">&lt;</span><span class="s1">IDmsDocumentRepository</span><span class="s2">, </span><span class="s1">DmsDocumentRepository</span><span class="s2">&gt;();</span>
<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddScoped</span><span class="s2">&lt;</span><span class="s1">ITagRepository</span><span class="s2">, </span><span class="s1">TagRepository</span><span class="s2">&gt;();</span>
<span class="s3">// builder.Services.AddScoped&lt;IProductRepository, ProductRepository&gt;();</span>
<span class="s3">// builder.Services.AddScoped&lt;IProductService, ProductService&gt;();</span>
<span class="s1">var connectionString </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">Configuration</span><span class="s2">.</span><span class="s1">GetConnectionString</span><span class="s2">(</span><span class="s4">&quot;DefaultConnection&quot;</span><span class="s2">);</span>

<span class="s1">builder</span><span class="s2">.</span><span class="s1">Services</span><span class="s2">.</span><span class="s1">AddDbContext</span><span class="s2">&lt;</span><span class="s1">DmsDbContext</span><span class="s2">&gt;(</span><span class="s1">options =&gt;</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">UseNpgsql</span><span class="s2">(</span><span class="s1">connectionString</span><span class="s2">));</span>
<span class="s1">var app </span><span class="s2">= </span><span class="s1">builder</span><span class="s2">.</span><span class="s1">Build</span><span class="s2">();</span>

<span class="s3">// Configure the HTTP request pipeline.</span>
<span class="s0">if </span><span class="s2">(</span><span class="s1">app</span><span class="s2">.</span><span class="s1">Environment</span><span class="s2">.</span><span class="s1">IsDevelopment</span><span class="s2">())</span>
<span class="s2">{</span>
    <span class="s1">app</span><span class="s2">.</span><span class="s1">UseSwagger</span><span class="s2">();</span>
    <span class="s1">app</span><span class="s2">.</span><span class="s1">UseSwaggerUI</span><span class="s2">();</span>
<span class="s2">}</span>

<span class="s1">app</span><span class="s2">.</span><span class="s1">UseHttpsRedirection</span><span class="s2">();</span>
<span class="s1">app</span><span class="s2">.</span><span class="s1">UseAuthorization</span><span class="s2">();</span>
<span class="s1">app</span><span class="s2">.</span><span class="s1">MapControllers</span><span class="s2">();</span>

<span class="s1">Console</span><span class="s2">.</span><span class="s1">WriteLine</span><span class="s2">(</span><span class="s4">&quot;Starting REST API&quot;</span><span class="s2">);</span>

<span class="s1">app</span><span class="s2">.</span><span class="s1">Run</span><span class="s2">();</span></pre>
</body>
</html>